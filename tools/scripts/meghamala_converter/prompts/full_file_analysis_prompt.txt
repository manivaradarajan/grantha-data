You are an expert system specializing in LLM performance optimization and Sanskrit text analysis. Your task is to perform a complete analysis of the provided markdown document and produce a single, unified JSON response containing four sections: `metadata`, `structural_analysis`, `chunking_strategy`, and `parsing_instructions`.

Your entire response must be a single, valid JSON object. Do not include any explanatory text or markdown formatting (like ```json) before or after the JSON object.

---

### **1. Metadata Section (`metadata`):**
Extract the metadata as described below.
*   `canonical_title`: Full Sanskrit name.
*   `grantha_id`: Standardized ID.
*   `commentary_id`: Commentary ID or `null`.
*   `commentator`: Name of the author in **Sanskrit Prathama Vibhakti (Nominative Singular)** (e.g., "श्रीरङ्गरामानुजमुनिः").
*   `authored_colophon`: A constructed Sanskrit phrase indicating authorship, following strict grammatical agreement rules:
    *   **Case:** Convert the author's name to **Plural Instrumental Case** (Tritiya Vibhakti Bahuvachana) to denote respect.
    *   **Agreement:** Append the word "viracita" (composed by), modified to match the gender of the commentary title.
    *   *Example (Feminine Commentary):* If commentary is *Prakāśikā* or *Ṭīkā*, use feminine ending with plural author: "श्रीरङ्गरामानुजमुनिभिः विरचिता".
    *   *Example (Neuter Commentary):* If commentary is *Bhāṣyam*, use neuter ending with plural author: "शंकराचार्यैः विरचितम्".

---

### **2. Structural Analysis Section (`structural_analysis`):**
Analyze and define the hierarchical structure of the document **and establish the starting coordinate.**

*   **Goal:** Identify all levels of division from the largest to the smallest (e.g., Prapathaka -> Khanda -> Mantra).
*   **Output Structure:** Represent this hierarchy as a nested JSON object under the `structure_levels` key. For each level, provide a `key` (PascalCase), and `scriptNames` for both Devanagari and roman scripts.
*   **Numbering Context (CRITICAL):**
    1.  **Identify Headers:** Look for the specific headers in the document corresponding to your identified structure levels (e.g., "Prathama Adhyaya", "Panchami Valli", "Dvitiya Patala").
    2.  **Translate Numerals:** Convert the Sanskrit ordinals or cardinals found in those headers into integers (e.g., *Prathama* -> 1, *Panchami* -> 5, *Ekadasha* -> 11).
    3.  **Determine Start ID:** Create a `starting_id` string in dot-notation (e.g., "5.1" or "2.3.1") that represents the full coordinate of the **first** unit (Mantra/Sutra/Verse) found in this text.
    4.  **Logic:**
        *   If the header is "Fifth Valli" and the first verse is "1", `starting_id` = "5.1".
        *   If the header is "Chapter 2", Sub-section "Section 3", and the first verse is "1", `starting_id` = "2.3.1".
        *   If no parent headers exist, `starting_id` = "1".

    5.  **Suggested Filename (Sort-Safe):** Generate a `suggested_filename` for file output.
        *   **Prerequisite:** You must have already calculated `metadata.grantha_id`, `metadata.commentary_id`, and `starting_id`.
        *   **Logic:**
            1.  **Slugify Commentary:** Take `metadata.commentary_id` (or `commentator` if ID is null), remove generic words like "bhashya" or "tika", and convert to a short, lowercase slug (e.g., "rangaramanuja").
            2.  **Format ID:** Take the `starting_id` (from step 3), replace dots (`.`) with hyphens (`-`), and **zero-pad** every segment to 2 digits (e.g., `1.1` -> `01-01`).
        *   **Pattern:** `{grantha_id}-{commentary_slug}-{formatted_id}`
        *   **Example:** `katha-upanishad-rangaramanuja-02-01`
        *   **Example 2:** If text is Chandogya (6.1.1) with Shankara: `"chandogya-shankara-06-01-01"`.

---

### **3. Chunking Strategy Section (`chunking_strategy`):**
Devise an optimal, deterministic chunking strategy following a strict validation protocol.

**Protocol:**
1.  **Goal:** Minimize API calls by grouping consecutive sections into the largest possible chunks that fit safely within limits.
2.  **Hard Rule:** Never split a primary section (e.g., `खण्डः`, `वल्ली`) internally.
3.  **Grouping Strategy (OPTIMIZED):**
    *   **Agglomerate:** Combine consecutive major structural units (e.g., Khandas) into a single chunk.
    *   **Soft Target:** Aim for a chunk size between **50,000 and 80,000 characters**.
    *   **Hard Cap:** Strictly ensure no chunk exceeds the **Safety Limit of 125,000 characters**.
    *   **Logic:** Start with the first section. Keep adding subsequent sections to the current chunk *until* adding the next section would breach the Safety Limit. Only then start a new chunk.
4.  **Calculation and Validation (CRITICAL):**
    *   For each chunk you propose in the `execution_plan`, you **MUST** calculate its character length and report it in the `estimated_character_count` field.
    *   **Self-Correction:** If any chunk exceeds 125,000 characters, you must split it (breaking only at a valid structural boundary) and regenerate the plan.
*   **Output:** Provide a machine-readable `execution_plan` that adheres to this protocol.

---

### **4. Parsing Instructions Section (`parsing_instructions`):**
Provide instructions for parsing the primary structural units (e.g., `खण्डः`) *within* each chunk.
*   `recommended_unit`: Name of the logical unit to parse.
*   `numbering_capture_strategy`: Brief explanation of how to extract the unit number (e.g., "Extract the Devanagari numeral at the end of the bold line").
*   `start_pattern`: Object with description, examples, and regex.
*   `end_pattern`: Object with description, examples, and regex.
*   `pre_content_handling`: Instructions for initial text like `शान्तिपाठः`.

---

### **Complete JSON Output Example:**
This is a hypothetical example for a different text to show the exact final structure you must produce. Your output should follow this structure precisely.

```json
{
  "metadata": {
    "canonical_title": "छान्दोग्योपनिषत्",
    "grantha_id": "chhandogya-upanishad",
    "commentary_id": "rangaramanuja-muni-prakashika",
    "commentator": "श्रीरङ्गरामानुजमुनिः",
    "authored_colophon": "श्रीरङ्गरामानुजमुनिभिः विरचिता",
    "structure_type": "khanda"
  },
  "structural_analysis": {
    "starting_id": "1.1.1",
    "context_justification": "The text contains headers for Prapathaka 1 (Prathama) and Khanda 1 (Prathama). The first parsed unit is Mantra 1. Thus, start ID is 1.1.1.",
    "suggested_filename": "chandogya-upanishad-rangaramanuja-01-01-01",
    "filename_justification": "Combines grantha ID, commentary author, and zero-padded start ID (01-01-01) for unique, sortable naming.",
    "structure_levels": {
      "key": "Prapathaka",
      "scriptNames": {
        "devanagari": "प्रपाठकः",
        "roman": "prapāṭhaka"
      },
      "children": {
        "key": "Khanda",
        "scriptNames": {
          "devanagari": "खण्डः",
          "roman": "khaṇḍa"
        },
        "children": {
          "key": "Mantra",
          "scriptNames": {
            "devanagari": "मन्त्रः",
            "roman": "mantra"
          }
        }
      }
    }
  },
  "chunking_strategy": {
    "proposed_strategy": {
      "name": "Validated Group by Character Count",
      "description": "This strategy combines consecutive Khandas, strictly ensuring no chunk exceeds the safety character limit. The plan is regenerated internally if any proposed chunk is too large.",
      "safety_character_limit": 125000
    },
    "execution_plan": [
      {
        "chunk_id": 1,
        "description": "Prefatory material and Khandas 1 through 7.",
        "start_marker": "शान्तिपाठः",
        "end_marker": "।। इति सप्तमखण्डभाष्यम् ।।",
        "estimated_character_count": 48500
      },
      {
        "chunk_id": 2,
        "description": "Khandas 8 through 13.",
        "start_marker": "**अष्टमः खण्डः**",
        "end_marker": "।। इति प्रथमप्रपाठकप्रकाशिका ।。",
        "estimated_character_count": 45200
      }
    ]
  },
  "parsing_instructions": {
    "recommended_unit": "Khanda",
    "justification": "The Prapathaka is primarily divided into Khandas, which are the main semantic and structural sections.",
    "numbering_capture_strategy": "Extract the Devanagari numeral found at the very end of the Mantra heading line (e.g. || 1 ||).",
    "start_pattern": {
      "description": "A new Khanda begins with a bolded heading indicating its number.",
      "examples": [
        "**प्रथमः खण्डः**",
        "**द्वितीयः खण्डः**"
      ],
      "regex": "\\*\\*([\\u0900-\\u097F]+) खण्डः\\*\\*"
    },
    "end_pattern": {
      "description": "The end of a Khanda is marked by a concluding line, typically mentioning the end of the section's commentary.",
      "examples": [
        "।। इति प्रथमखण्डभाष्यम् ।।",
        "।। इति द्वितीयखण्डभाष्यम् ।।"
      ],
      "regex": "।। इति .*?खण्डभाष्यम् ।।"
    },
    "pre_content_handling": "Handle the initial 'शान्तिपाठः' as a 'Prefatory' section before the first Khanda."
  }
}
